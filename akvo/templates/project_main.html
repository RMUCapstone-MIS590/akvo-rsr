{% extends "base.html" %}

{% load compressed i18n rsr_utils %}

{% block title %}{{project.title}}{% endblock %}

{% block head_js %}
    <script type="application/json" id="accordion-data">{{ accordion_data|safe }}</script>
    <script type="application/json" id="carousel-data">{{ carousel_data|safe }}</script>

    <!-- Timeline -->
    <link rel="stylesheet" type="text/css" href="http://cdn.knightlab.com/libs/timeline/latest/css/timeline.css">
    <script type="text/javascript" src="http://cdn.knightlab.com/libs/timeline/latest/js/storyjs-embed.js"></script>

    <script>
        $(document).ready(function() {
            var timeline_data = {{ timeline_data|safe }}

            createStoryJS({
                type:       'timeline',
                width:      '100%',
                height:     '400',
                source:     timeline_data,
                embed_id:   'timeline'
            });
        });
    </script>
{% endblock %}

{% block maincontent %}

<article class="touch-navbar project-container">
    {% include "partials/project_header.html" %}

    <div class="container">
        {% if not project.is_published %}
            <div id="draft" class="row">This is a draft view of the project. It can only be seen by Administrators and Project editors.</div>
        {% endif %}
        <div class="row">
            <div class="col-sm-8">
                <div id="carousel"></div>
            </div>
            <div class="col-sm-4">
                <p>{{project.project_plan_summary}}</p>
                {% if project.iati_activity_id %}
                <p><span class="detailedInfo">IATI ID</span> {{project.iati_activity_id}}</p>
                {% endif %}
                <p><span class="detailedInfo">Status</span> {{project.get_status_display}}</p>
                {% if project.has_relations %}
                <p><span class="detailedInfo">Hierarchy</span>
                    This project has {{project.parents.count}} parent project{{project.parents.count|pluralize}},
                    {{project.children.count}} child project{{project.children.count|pluralize}} and
                    {{project.siblings.count}} sibling project{{project.siblings.count|pluralize}}
                    <a href="{% url 'project-hierarchy' project.pk %}">View full hierarchy</a></p>
                {% endif %}
                <p><a href="#">View project's full data report</a></p>
                {% if project.focus_areas %}
                <p><span class="detailedInfo">{% trans "Focus Areas" %}</span>
                <a href="{% url 'project-directory' %}?focus_area={{project.focus_areas.0.id}}">{{project.focus_areas.0.name}}</a>
                    {% if project.focus_areas.distinct.count > 1 %}
                    <a href="javascript:;" class="small" data-toggle="tooltip"
                       title="{% for area in project.focus_areas.all.distinct %}
                                  {% ifnotequal area.id project.focus_areas.0.id %}
                                      <a href='{% url 'project-directory' %}?focus_area={{area.id}}'>{{area.name}}</a><br>
                                  {% endifnotequal %}
                              {% endfor %}"
                       data-placement="right">+{{project.focus_areas.distinct.count|add:"-1"}} more</a>
                    {% endif %}
                </p>
                {% endif %}
                {% if project.sector_names %}
                <p><span class="detailedInfo">{% trans "Sectors" %}</span>
                {{project.sector_names.0}}
                    {% if project.sector_names|length > 1 %}
                    <a href="javascript:;" class="small" data-toggle="tooltip"
                     title="{% for name in project.sector_names %}
                                {% ifnotequal name project.sector_names.0 %}{{name}}<br>{% endifnotequal %}
                            {% endfor %}"
                     data-placement="right" data-container="body">+{{project.sector_names|length|add:"-1"}} more</a>
                  {% endif %}
                </p>
                {% endif %}
                <p><span class="detailedInfo">Partners</span>
                <div class="row">
                    <a href="{% url 'organisation-main' first_partner.0.pk %}" class="pull-left">
                        {% img first_partner.0 80 60 first_partner.0.title %}
                    </a>
                    <div class="media-body">
                        <p>
                            <a href="{% url 'organisation-main' first_partner.0.pk %}">{{first_partner.0}}</a>
                            {% for partner_type in first_partner.1 %}
                                <br>{{partner_type}} partner
                            {% endfor %}
                        </p>
                    </div>
                </div>
                    {% for partner, types in partners.items %}
                        {% ifnotequal partner project.first_partner %}
                            <div class="row">
                                <a href="{% url 'organisation-main' partner.pk %}" class="pull-left">
                                    {% img partner 80 60 partner.title %}
                                </a>
                                <div class="media-body">
                                    <p>
                                        <a href="{% url 'organisation-main' partner.pk %}">{{partner}}</a>
                                        {% for type in types %}
                                            <br>{{type}} partner
                                        {% endfor %}
                                    </p>
                                </div>
                            </div>
                        {% endifnotequal %}
                    {% endfor %}
            </div>
        </div>
        <div class="row">
            <div class="col-sm-3 col-xs-6 col-ty-12">
                <h4 class="detailedInfo">Finance</h4>
                {% include "partials/project_budget.html" %}
                <p class="center-text"><a href="#">See all financial info</a></p>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-12">
                <div id="timeline"></div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-8">
              <div id="accordion"></div>
              {% compressed_js 'rsr_v3_react_project_main' %}
              {% comment %}
              <script type="application/javascript" src="/static/rsr/v3/js/build/rsr_v3_project_main.min.js" charset="utf-8"></script>
              {% endcomment %}
            </div>
            <div class="col-sm-4">
              <h4 class="detailedInfo">Latest project updates</h4>
              {% for update in updates%}
              <a href="{{update.get_absolute_url}}">{{update.title}}</a>
              {% endfor %}

              <p>Updates</p>


            </div>
        </div>
    </div>

    {% include "partials/project_footer.html" %}
</article>
{% endblock %}

{% block jq %}
    $(function () {
      $('[data-toggle="tooltip"]').tooltip({html: true, delay: { "show": 0, "hide": 1000 }})
    })
{% endblock %}
