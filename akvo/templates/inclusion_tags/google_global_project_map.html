{% load i18n l10n templatetag_handlebars %}

{# HTML markup #}
<div id="map_canvas" style="width: {{ width }}px; height: {{ height }}px;"></div>
{% tplhandlebars 'map_info_window_template' %}
<div class="map_info_window">
  <a href="{{url}}">{{title}}</a>
  <p class="small gray">More information goes here...</p>
</div>
{% endtplhandlebars %}

{# External scripts #}
<script src="//maps.google.com/maps/api/js?sensor=false"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7/jquery.min.js"></script>

{# Local scripts #}
<script src="{{MEDIA_URL}}core/js/jquery.ui.map.full.min.js"></script>
{% handlebars_js %}

<script>
  var data_url = '{{ data_url }}', {# to be replaced with Akvo RSR API resource #}
      map_options = {
        center: new google.maps.LatLng(0, 0),
        mapTypeId: google.maps.mapTypeId.ROADMAP,
        scrollwheel: false,
        streetViewControl: false
      },
      map_type = '{{ map_type }}',
      marker_icon = '{{ marker_icon }}';

  if (map_type === 'static') {
    icon = new google.maps.MarkerImage(marker_icon, null, null, null, new google.maps.Size(10.5, 17));
    map_options.draggable = false;
    map_options.disableDefaultUI = true;
  } else {
    icon = new google.maps.MarkerImage(marker_icon);
  }

  jQuery.noConflict();
  jQuery(document).ready(function($) {
    var map_canvas = $('#map_canvas');
    map_canvas.gmap(mapOptions).bind('init', function() {
      $.getJSON(data_url, function(data) {
        $.each(data, function(i, project) {
          var position = new google.maps.LatLng(project.latitude, project.longitude);
          map_canvas.gmap('addMarker', {
              'bounds': true,
              'icon': icon,
              'position': position,
              'title': project.title
          })
          .click(function() {
            var template = Handlebars.compile($('#map_info_window_template').html()),
                content = template(project);
            map_canvas.gmap('openInfoWindow', {'content': content}, this);
          });
        });
      });
      // setCSS();
    });
  });
  
  function setCSS() {
    var css, head, style, rules;  

    css = '#map_canvas {font-size: 12px; font-family: Arial, Helvetica, "Liberation Sans", FreeSans, sans-serif;}';
    css += '.map_info_window {min-height: 150px;}';
      
    head = document.getElementsByTagName('head')[0];
    style = document.createElement('style');
    rules = document.createTextNode(css);

    style.type = 'text/css';
    if(style.styleSheet){
      style.styleSheet.cssText = rules.nodeValue;
    } else { 
      style.appendChild(rules);
    }
    head.appendChild(style);      
  }
</script>
