{% extends "rsr/base.html" %}
{% load i18n rsr_tags rsr_filters webdesign thumbnail counter_tags cache %}
{% load markup_tags humanize sorting_tags pagination_tags %}
{% load url from future %}


{% block title %}
  {% if org %}
    - {% trans 'Project listing for' %} {{org.name}}
  {% else %}
    {% if focus_area.slug != 'all' %}
      - {% trans 'Projects' %} - {{focus_area.name}}
    {% else %}
      - {% trans 'All projects' %}
    {% endif %}
  {% endif %}
{% endblock title %}


{% block breadcrum_items %}
  {% if org %}
    {{block.super}}
      <li><a href="{% url 'project_list' %}"><span>{% trans 'Projects' %}</span></a></li>
      <li id="last_breadcrum_item">{% trans 'Project listing for' %} {{org.name}}</li>
  {% else %}
    {% if focus_area.slug != 'all' %}
      {{block.super}}
        <li><a href="{% url 'project_list' %}"><span>{% trans 'Projects' %}</span></a></li>
        <li id="last_breadcrum_item">{{focus_area.name}}</li>
    {% else %}
      {{block.super}}
        <li id="last_breadcrum_item">{% trans 'All projects' %}</li>
    {% endif %}
  {% endif %}
{% endblock breadcrum_items %}

{% block maincontent %}

<div class='container'>

  <div class='column span-14'>
    {% if org %}
      <h1 class="h0"><a href="{{org.get_absolute_url}}">{% trans 'Project listing for' %} {{org.name}}</a></h1>
      <div class='column span-14 last'>
        <a href="{{org.get_absolute_url}}">{% org_logo org 240 180 'float: left; margin: 0 20px 20px 0;' %}</a>
        <p>
          {{org.description|linebreaks}}
        </p>
      </div>    
    {% else %}
      <h1 class="h0">{{focus_area}} {% trans 'projects' %}</h1>
      <div id="focus_area_description" class="column span-{% if focus_area.slug != 'all' %}11{% else %}14{% endif %}">
        <img width="240" height="180" style="float: left; margin: 0 20px 20px 0;" src="{% thumbnail focus_area.image 240x180 sharpen %}" alt="{{focus_area}}"/>
        {{focus_area.description|apply_markup:"markdown"}}
      </div>
      {% if focus_area.slug != 'all' %}
        <div class='column span-3 last'>
          <div class="white_box blue_tint">
            <div class="space20">
              <h2>Related focus area</h2>
              <a href="/web/{{focus_area.slug}}" class="small">{% trans 'Learn more about'%} <br/>{{focus_area}}&nbsp;<span class="link_triangle">&#x25BA;</span></a>
            </div>
          </div>
        </div>
      {% endif %}
    {% endif %}

	<div class='column span-14 last'>
      <h1>{% trans 'Our projects' %}
        <span class="lt_grey">
          {% blocktrans count projects.count as projects_count %}
            ({{projects_count}} result)
          {% plural %}
            ({{projects_count}} results)
          {% endblocktrans %}
        </span>
      </h1>
	</div>
	{# -------- #}
	<div class='column span-14 last'>
		
		<form action="." method="get" accept-charset="utf-8" name="filter_form">
			<div id="project_search" class="span-18">
				<div class="round" style="border: 1px solid #ccc;">
					<div class="space15">
						<input id="q" name="q" 
							type="search" style="margin-left:20px;margin-top:4px;width:300px;display:inline;" 
							value="{{ query_string|escape }}">

						<select name="continent" id="continent" size="1" style="margin-left:40px;width:120px; margin-top:4px;">
							<option value="all">{% trans 'All continents' %}</option>
							{% for continent in continents %}
							<option value="{{continent.0}}"
								{% ifequal continent.0 selected_continent %} SELECTED {% endifequal %}>
								{{continent.1}}
							</option>
							{% endfor %}
						</select>
						&nbsp;
						<select name="country" id="country" size="1" style="width:120px; margin-left:10px; margin-top:4px;">
							<option id="all_country" value="all">{% trans 'All countries' %}</option>
							{% if selected_continent == 'all' %}	
								{% for country in countries %}
								<option value="{{country.id}}"
									{% ifequal country.id selected_country %} SELECTED {% endifequal %}>
									{{country.country_name}}
								</option>
								{% endfor %}
							{% endif %}
							{% if selected_continent == 1 %}
								{% for country in countries_in_africa %}
								<option value="{{country.id}}"
									{% ifequal country.id selected_country %} SELECTED {% endifequal %}>
									{{country.country_name}}
								</option>
								{% endfor %}
							{% endif %}
							{% if selected_continent == 2 %}
								{% for country in countries_in_asia %}
								<option value="{{country.id}}"
									{% ifequal country.id selected_country %} SELECTED {% endifequal %}>
									{{country.country_name}}
								</option>
								{% endfor %}
							{% endif %}
							{% if selected_continent == 3 %}
								{% for country in countries_in_australia %}
								<option value="{{country.id}}"
									{% ifequal country.id selected_country %} SELECTED {% endifequal %}>
									{{country.country_name}}
								</option>
								{% endfor %}
							{% endif %}
							{% if selected_continent == 4 %}
								{% for country in countries_in_europe %}
								<option value="{{country.id}}"
									{% ifequal country.id selected_country %} SELECTED {% endifequal %}>
									{{country.country_name}}
								</option>
								{% endfor %}
							{% endif %}
							{% if selected_continent == 5 %}
								{% for country in countries_in_north_america %}
								<option value="{{country.id}}"
									{% ifequal country.id selected_country %} SELECTED {% endifequal %}>
									{{country.country_name}}
								</option>
								{% endfor %}
							{% endif %}
							{% if selected_continent == 6 %}
								{% for country in countries_in_south_america %}
								<option value="{{country.id}}"
									{% ifequal country.id selected_country %} SELECTED {% endifequal %}>
									{{country.country_name}}
								</option>
								{% endfor %}
							{% endif %}

						</select>
					
						<select name="organisation" id="organisation" size="1" style="margin-left:40px;width:150px; margin-top:4px;">
							<option value="all">{% trans 'All partners' %}</option>
							{% for organisation in organisations  %}
								<option value="{{organisation.id}}">{{organisation.name}}</option>
							{% endfor %}
						</select>
						<a id="filterButton" class="blue awesome" style="float:right;"
							href="javascript:document.filter_form.submit();">
							<span>{% trans 'Filter' %}</span>
						</a>
						{% comment %}
						<a id="filterButton" class="blue awesome" style="float:right;"
							href="javascript:document.filter_form.submit();" onclick="this.blur();">
							<span>{% trans 'Filter' %}</span>
						</a>
						{% endcomment %}
						<input type="submit" value="Filter" 
							style="display:none;">
						{% comment %}
						<input type="submit" value="Filter" 
							style="display:inline; margin-left:15px; margin-top:20px;">
						{% endcomment %}

						<div id="q_help" style="padding-left:25px; margin-top:10px;">
							<p class="tiny grey" style="margin-bottom:0; padding-bottom:0;">
								{% trans 'Filter on project name or subtitle' %}
							</p>
						</div>
					</div>
				</div>
			</div>
		</form>
	</div>
	
	
	{# -------- #}
	 <div class='column span-14 last'>
      {% autosort projects %}
      {% autopaginate projects 10 %}
      <div class="white_box">
        {% paginate %}
        <table id="projects">
          <colgroup class="name_col"></colgroup>
          <colgroup span="6" class="colgroup"></colgroup>
          <tr>
            <th style="padding: 10px;">
              {% anchor name Name %}
            </th>
            <!--<th class="activeTableHeaderDesc">
              <a href="#" class="small">
                <div class="activeTableHeaderDesc">Country</div>
              </a>
            </th>-->
            <th>{% anchor country Country %}</th>
            <th>
               {% anchor country__continent Continent %}
            </th>
            <th>
              {% anchor status Status %}
            </th>
            <th>
              {% anchor latest_update 'Latest update' %}
            </th>
            <th>
                <p class="small">Partners</p>
            </th>
            <th style="border-right: 0;">
                <p class="small">Focus area</p>
            </th>
          </tr>
          {% for project in projects %}
            <tr>
              <td>
                <div class="space10">
                  <a href="{% url 'project_main' project.id %}">
                    {% project_thumb project 100 75 'float:left; margin: 0 10px 10px 0;' %}
                    <p class="nano-lede strong link_blue">
                        {{project.name}}
                    </p> 
                  </a>
                  <p class="nano-lede">
                    {{project.project_plan_summary|capfirst|smart_truncate:100}}
                  </p> 
                </div>
              </td>
              <td>
                <p class="td-text">{{project.primary_location.country}}</p>
              </td>
              <td>
                <p class="td-text">{{project.primary_location.country.get_continent_display}}</p>
              </td>
              <td>
                <p class="td-text green">{{project.show_status}}</p>
              </td>
              <td>
                <p class="td-text">
                    {% if project.latest_update %}
                      <a href="{% url 'project_updates' project.id %}#{{project.update_id}}">{{project.latest_update|string_to_date|date:"d M Y"}}</a>
                    {% else %}
                      {% trans 'Not yet' %}
                    {% endif %}
                </p>
              </td>
              <td>
                <p class="td-text">
                  {% for partner in project.project_partners.all %}
                    <a href="{% url 'org_detail' partner.partner.id %}">{{partner.partner}}</a>{% if not forloop.last %}<br />{% endif %}
                  {% endfor %}
                </p>
              </td>
              <td>
                <p class="td-text">
                    {% for area in project.focus_areas %}
                        <a href="{% url 'focus_area' area.slug %}">{{area.name}}</a><br/>
                    {% endfor %}
                </p>
              </td>
            </tr>
          {% endfor %}
        </table>
        {% paginate %}
      </div>
    </div>
  </div>

</div> 

{% endblock maincontent %}


{% block jq_ready %}
	{{block.super}}
	
	jQ('#organisation').val({{org.id}});

	jQ('#continent').change(function() {

		function Country(countryName, countryId) {
			this.countryName = countryName;
			this.countryId = countryId;
			this.getName = function () { return this.countryName; }
			this.getId = function () { return this.countryId; }
		}

		function add_countires(countries) {
			jQ('#country >option').remove();
			jQ('#country').append('<option value="all">{% trans 'All countries' %}</option>');
			for (var i=0; i < countries.length; i++) {				
				jQ('#country').append('<option value="' + countries[i].getId() + '">' 
					+ countries[i].getName() + '</option>');
			};
		}

		var all_countries = [];
		{% for country in countries %}
			all_countries[all_countries.length] = new Country('{{country.country_name}}',{{country.id}});
		{% endfor %}

		var countries_in_africa = [];
		{% for country in countries_in_africa %}
			countries_in_africa[countries_in_africa.length] = new Country('{{country.country_name}}',{{country.id}});
		{% endfor %}

		var countries_in_asia = [];
		{% for country in countries_in_asia %}
			countries_in_asia[countries_in_asia.length] = new Country('{{country.country_name}}',{{country.id}});
		{% endfor %}

		var countries_in_australia = [];
		{% for country in countries_in_australia %}
			countries_in_australia[countries_in_australia.length] = new Country('{{country.country_name}}',{{country.id}});
		{% endfor %}

		var countries_in_europe = [];
		{% for country in countries_in_europe %}
			countries_in_europe[countries_in_europe.length] = new Country('{{country.country_name}}',{{country.id}});
		{% endfor %}

		var countries_in_north_america = [];
		{% for country in countries_in_north_america %}
			countries_in_north_america[countries_in_north_america.length] = new Country('{{country.country_name}}',{{country.id}});
		{% endfor %}

		var countries_in_south_america = [];
		{% for country in countries_in_south_america %}
			countries_in_south_america[countries_in_south_america.length] = new Country('{{country.country_name}}',{{country.id}});
		{% endfor %}

		var selected_continent = jQ('#continent').val();		
		
		if (selected_continent == 1 ) {		
			add_countires(countries_in_africa);
		} 
		else if (selected_continent == 2 ) {		
			add_countires(countries_in_asia);
		}
		else if (selected_continent == 3) {
			add_countires(countries_in_australia);
		}
		else if (selected_continent == 4) {
			add_countires(countries_in_europe);
		}
		else if (selected_continent == 5) {
			add_countires(countries_in_north_america);
		}
		else if (selected_continent == 6) {
			add_countires(countries_in_south_america);
		}
		else {
			add_countires(all_countries);	
		}

	});

{% endblock jq_ready %}