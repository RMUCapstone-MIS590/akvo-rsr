{% extends "rsr/base.html" %}

{% load i18n webdesign rsr_filters thumbnail counter_tags cache humanize %}
{% load oembed_tags markup_tags google_maps %}
{% load url from future %}

{% block inline_styles %}
#index_feature_box {
	background: transparent url({% thumbnail cms.feature_image 645x484 sharpen autocrop crop upscale %}) no-repeat;
}
{% endblock inline_styles %}

{% block breadcrum  %}{% endblock breadcrum  %}

{% block maincontent %}

{% if preview %}
  <div id="preview_cover"></div>
  <div id="preview_alert">
    <h1 style="color: yellow;">{% trans 'Preview!' %}</h1><a href="{% url 'admin:rsr_minicms_change' cms.pk %}">{% trans 'Return to admin' %}</a>
  </div>
{% endif %}

<<<<<<< HEAD
<div class='container'>

  <div class='column span-12'>
    <div class='column span-12'>
      <div id="feature_box" class="white_box">
        {{cms.feature_box|apply_markup:"markdown"}}
      </div>
    </div>
  
    <div class='column span-12'>
      <div class="white_box gutter-top" style="background-color:#f1f1f1;">
        <div class="space5" style="padding-left: 15px;">
          <h3 style="display: inline;">{% trans 'Latest news:' %} </h3><a href="{{news_post.url}}">{{news_post.title}}</a>
        </div>
      </div>
    </div>
    
    <div class='column span-12 gutter-top'>
      <div style="margin-bottom: .4em;">
        <h1 class="top_of_box">{% trans 'Most recent project updates' %}</h1>
        <a class="small top_of_box" style="margin-left: 2em;" href="{% url 'akvo_feeds' 'all-updates' %}">
          RSS
          <img src="{{MEDIA_URL}}core/img/icon_rss.gif" width="12" height="12" alt="Icon Rss"  style="margin-left:5px; margin-right:0">
        </a>
      </div>
      
      {% for update in updates %}
      <div class='column span-4{% if forloop.last %} last{% endif %}'>
        <div class="white_box" style="min-height: 370px;">
					{% if update.photo %}
            {% thumbnail update.photo 203x152 crop sharpen upscale as update_photo %}
            {% if update_photo %}
              <a href="{% url 'project_update' update.project.id update.id %}">
                <img src="{{update_photo}}" style="margin:0;"{% if update.photo_caption %} title="{{update.photo_caption}}"{% endif %}/>
              </a>
            {% endif %}
          {% endif %}
          <div class="space10">
            <a href="{% url 'project_update' update.project.id update.id %}">
              <h2 class="link_blue">{{update.title|smart_truncate:40}}</h2>
            </a>
            <p class="small grey last">
              {% blocktrans with update.user.get_full_name as user_name and update.user.userprofile.organisation.name as user_org and update.user.userprofile.organisation.get_absolute_url as org_url and update.get_update_method_display as update_meth and update.time|date:"Y-m-d" as update_time %}By {{user_name}}, <a href="{{org_url}}">{{user_org}}</a>, via {{update_meth}} on {{update_time}}{% endblocktrans %}
              <br/>{{update.project.country}}
            </p>
            <p class="small last">
              {{update.text|smart_truncate:100}}
            </p>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    
    <div class='column span-12 gutter-top'>
        
      <div style="margin-bottom: .4em;">
        <h1 class="top_of_box">{% trans 'Recent blog posts' %}</h1>
        <a class="small top_of_box" style="margin-left: 2em;" href="/blog/?feed=rss2">
          RSS
          <img src="{{MEDIA_URL}}core/img/icon_rss.gif" width="12" height="12" alt="Icon Rss"  style="margin-left:5px; margin-right:0">
        </a>
      </div>

      <div class="white_box" style="background-color:#fff;">
        {% for blog_post in blog_posts %}
          <div class="space20">
            {% if blog_post.image %}
              <img src="{{blog_post.image}}" width="200" style="margin: 0 20px 15px 0; float: left;">
            {% endif %}
            <a class="strong" href="{{blog_post.url}}"><h2 class="link_blue serif">{{blog_post.title}}</h2></a>
            <p class="small grey" style="margin-bottom: .5em;">{{blog_post.date|date:"l, j F Y"}} {% trans 'by' %} {{blog_post.author}}</p> 
            <p class="small">{{blog_post.text|striptags|smart_truncate:300}}</p> 
          </div>
          {% if not forloop.last %}
            <div style="margin: 0 8px;"><hr/></div>
          {% endif %}
        {% endfor %}
        <div class="h1_companion" style="margin: 20px; margin-top: 0;">
          <a href="/blog">{% trans 'Read earlier blog posts' %} <span class="link_triangle">&#x25B6;</span></a>
        </div>          
        <div class="clear"></div>
      </div>

    </div>
  </div>
     
  <div class='column span-6 last'>
    <div class="white_box" style="height: 361px; background:url({{MEDIA_URL}}akvo/img/earth-300x78.png) no-repeat bottom;">
      <div id="top_right_box" class="space20">
        {{cms.top_right_box|apply_markup:"markdown"}}
      </div>
    </div> 
  </div>

  <div class='column span-6 gutter-top last'>
    <div class="right_now_box">
      <div style="padding: 20px 20px 0px 20px;">
        <h1 class="right_now_green">{% trans 'Right now in Akvo.org...' %}</h1>
        <div class="clear"></div>
      </div>
      <div class='column span-3 border' style="margin-bottom:20px">
        <div style="padding-left: 20px;">
          <h1 class="white last" style="line-height: 1em">{{projects.count}}</h1>
          <p class="small"><a class="right_now_blue" href={% url 'project_list' %}>{% trans 'Projects' %}</a></p>
          <h1 class="white last" style="line-height: 1em">{{orgs.count}}</h1>
          <p class="small"><a class="right_now_blue" href={% url 'rsr_org_list' %}>{% trans 'Project partners' %}</a></p>
          <!--<h1 class="white last" style="line-height: 1em">000</h1>
          <p class="small lt_grey last">{% trans 'Countries' %}</p>-->
        </div>
      </div>
      <div class='column span-3 last' style="margin-bottom:20px">
        <div style="padding-left: 20px;">
          <h1 class="white last" style="line-height: 1em">{{people_served|intcomma}}</h1>
          <p class="small lt_grey">{% trans 'People served' %}</p>
          <h1 class="white last" style="line-height: 1em">â‚¬ {{projects_total_total_budget}}M</h1>
          <p class="small lt_grey last">{% trans 'In project budgets' %}</p>
        </div>
      </div>
      <a href="{% url 'global_project_map' %}">
        {% google_global_project_map 'static' 315 190 1 %}
      </a>
      <div style="padding: .5em .5em .7em .5em;">
        <a class="right small right_now_blue" href="{% url 'global_project_map' %}">{% trans 'Global project map' %} <span class="link_triangle">&#x25B6;</span></a>
        <div class="clear"></div>
      </div> 
    </div> 
  </div>

<!--
-->
  <div class='column span-6 gutter-top last'>
    <div style="margin-bottom: .4em;">
      <h1 class="top_of_box">{% trans 'Project focus areas' %}</h1>
      <a class="small" style="margin-left: 2em;" href="/web/focus-areas">See all <span class="link_triangle">&#x25B6;</span></a>
    </div>
    <div id="index-accordion" style="height: {{cms.lower_height|add:-69}}px;">
      <div id="accordion">
        {% for focus_area in focus_areas %}
        <h3><a href="#">{{focus_area.name}}</a></h3>
        <div>
          <img src="{% thumbnail focus_area.image 275x206 sharpen %}" alt="{{focus_area}}"/>
            {{focus_area.description|smart_truncate:120|apply_markup:"markdown"}}
            <div class="h1_companion">
              <a style="color: #1877B8;" href="{% if focus_area.link_to %}{{focus_area.link_to}}{% else %}{{ focus_area.get_absolute_url }}{% endif %}">{% trans 'Browse projects / read more' %} <span class="link_triangle">&#x25B6;</span></a>
            </div>
        </div>
        {% endfor %}
      </div>              
    </div>          
  </div>
</div>
{% endblock maincontent %}

{% block js %}
	{{ block.super }}
  <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.4/jquery-ui.min.js"></script>
	<script>
		!window.jQuery && document.write('<script src="{{MEDIA_URL}}akvo/js/src/jquery-ui-1.8.5.custom.min.js"><\/script>')
	</script>
{% endblock js %}

{% block jq_ready %}
	{{ block.super }}
  $("#accordion").accordion();
  $("#accordion").accordion({ fillSpace: true });
  $("#accordion").accordion( "resize" )
{% endblock jq_ready %}
