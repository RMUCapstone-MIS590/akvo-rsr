# Media Packer

## Goal
To be able to handle css & javascript files in a more organised and efficient way. And at the same time provide better performance by reduce http requests, enable better use of browser cache and compression of css & javascript files. 

## What
Instead of having a large css file we want to have several small ones. Each representing a block of styles, a block can be part of the site such as 'typography' or 'mainnav'. The use of several small css files makes it much easier to manage updates and retain an overview of the evolving styles and scripts. At the same time we don't want to serve several css & javascript files to the user. This since each separate file creates an extra http request which is dreadful for performance. That's why we should combine all css files into one and only serve that one. While we are at it we will also compress the files using Yahoo's great YUICompressor.

## How
We define media bundles in a python file. Each media bundle consists of one or more source files. All those source files will be combined into one file representing the bundle for use on the site.

### Overview
When a developer makes a commit in git the packer script parses the media_bundles.py file where we have defined our media bundles. For each defined bundle the source files are combined into one file. The file is persisted to disk, and also added to the git index. In our templates we can then with the 'media_bundle' template tag call for a specific media bundle e.g. {% media_bundle 'akvo_style' %}. Depending on the media bundle type (css or js) the template tag will add the corresponding code block pointing to the combined file.

###In depth
Besides combining the bundles files the media packer also enables support for compression of bundle files, naming based on the content (with a hash) and a way to make development easier by bypassing the combined files and link directly agains the source files.

The media packer uses the YUICompressor(http://developer.yahoo.com/yui/compressor/) for compressing the bundle files, compression is selectable with the 'compress' (True, or False) setting.

The combined files are named with a fingerprint (hash) based on the file contents. This makes it possible to set expires header to the files on the webserver. In practice this will make users cache styles and javascript files on their first visit. Since we thanks to the fingerprint naming can have a very long expire date, it's a good chance the user will not need to download those from our server but use their browsers cache. The fingerprint nameing forces users to download new styles and javascipt if we have updates them since last time they visited out website. The template tag uses a map file named map.py to locate the current file name for the bundle. This file is separated from the media_bundles file since we don't wan't to mix user defined files and auto generated files. In this way one can make comments in the media_bundles.py file without any risk of confusion.

The development mode is utilised by adding a DEV_MEDIA_BUNDLES=TRUE to the settings file. For styles the template tag will link against a raw file which are generated by the packer script. The raw file then imports the source files by using css @imports. For javascript the template tag will link directly to the source files.

### Media packer elements
- A media_bundle.py file where bundles are defined.
- A map.py file used by Django for lookups.
- A packer script that generate combined & compressed bundle files. It also populates the map.py.
- A media_bundle Django template tag which uses the map.py for lookups.
- A git hook "pre-commit" that call the packer script before a commit.
- On first request and execution of the scripts/media_packer/__init__.py a symlink to the git hook is setup.
- A DEV_MEDIA_BUNDLES=TRUE setting.
- Add expires header to the apache configuration.

## Things to consider

### Conventions
One can name the source files to whatever but it's recommended to use a prefix such as "x_" e.g. x_style_name.css.

### Aborted commits
If the script stumbles upon errors because of a misconfiguration of the media_bundles the commit will be aborted. This is done by design. We don't want to checkin broken code. And only changes to the media bundles will be a possibility for those errors.

### Git hook setup
The pre-commit git hook is setup on the first http request. Hence if you clone the system the git-hook will not be in place before you have run the project. If you want you can always manually symlink the pre-commit hook from ".git/hooks/" to "git_hooks/" in the project root. The automatic sym-linking is made in "akvo/scripts/media_packer/__init__.py"

### New source files
If you want to add a new source file to a bundle the actual media_bundle definition needs to commit before it's used for combining. Hence you need an extra commit of adding the source file to media_bundles and then before the second commit the pre-commit hook is triggered and that will generate a new combined file.

## Resources:
http://developer.yahoo.com/performance/rules.html
http://developer.yahoo.com/yui/compressor/
http://cjohansen.no/en/apache/using_a_far_future_expires_header

## Roadmap:
Would be nice to have validation of css & javascript(maybe even JSLint) as a requirement.