# RSR Asset Manager

## Purpose
RSR Asset Manager is an effort to optimise organisation and efficiency of the Cascading Style Sheets (CSS) and Javascript (JS) use in Akvo RSR. 

## Principles

### Organisation
It is very easy to become unorganised with CSS & JS files. This is particular true for CSS. To maintain organised it’s a good strategy to split the CSS classes into separate smaller files. Where one file covers one logical area of the site. It might be a specific page or something like the typography. This makes it much easier to understand where the styles is used and how to update the styles in the future.

### Performance

#### Minimise the number of HTTP requests
To minimise the number of HTTP requests is very to improve first time visitors performance. Hence we don’t want to serve several CSS & JS files (Asset files). We will need to combine each bundle into one file and serve the combined file to the user.

#### Make use of the users browser cache
We want the users browser to cache files as much as possible. This is enabled by setting far future expires headers on asset files. This will make the browser grab the files from a local cache instead of downloading them again. At the same time we need a way to make sure that new asset files are downloaded so the old browser cached versions not are used. This issue is solved by renaming the asset file based on it’s contents.

#### Keep the asset files small for faster download
To optimise the page speed we want to keep the asset files as small as possible. Because of this we will minimise the asset files with the help of the YUICompressor. This tool have been reported to shrink file sizes with ~20%. 

#### Minimise manual labour
Since we don’t want to do anything manual that we don’t need to we will use Git to regenerate the asset files automatically. Since git have a pre-commit hook we will use that to make sure the asset files always are up to date!

## Implementation

### Overview
We will use a Python dictionary to define media bundles. You will load a media bundle where you used to load a css or a javascript file in the templates. A media bundle can consist of one or several CSS or JS files. The media bundles will then be loaded in the template with a Django template tag. A Git hook is used to automatically repack the media bundles on a new commit. 

### Asset Manager elements
- akvo/scripts/asset_manager/asset_bundle.py file where asset_bundles are defined.
- akvo/scripts/asset_manager/ map.py file used by Django for template tags lookups.
- akvo/scripts/asset_manager/ packer.py generates combined & compressed bundle files. It also populates the map.py file.
- {% asset_bundle ‘foo’ %} Django template tag which uses the map.py for lookup.
- "pre-commit" git hook that call the packer script before a commit.
- On first request and execution of the scripts/media_packer/__init__.py a symlink to the git hook is made.
- A DEV_ASSET_BUNDLES=TRUE setting.
Add expires header to the apache configuration. (optional)


### In depth / example
On commit the git hook kickstarts the packer script which parses the asset_bundle.py files for asset_bundles. When it finds a bundle, e.g. ‘akvo_styles’, it reads the bundle settings and starts to combine the bundle files (e.g. ‘typography” or ”footer”) into one bundle file. When this is done the bundle file is compressed with YUICompressor. The combined and compressed file is then named with a fingerprint (hash) based on it’s contents. The hash is added to the map.py file for Django template tag lookup. In the template we would then add the template tag {% asset_bundle ‘akvo_styles’ %} to load the latest fingerprinted bundle file. 

### Development mode
The development mode is utilised by adding a ASSET_MANAGER_DEV =TRUE to the settings file. For styles the template tag will link against a raw file which are generated by the packer script. The raw file then imports the source files by using css @imports. For javascript the template tag will link directly to the source files.

## Things to consider

### Conventions
One can name the source files to whatever but it's recommended to use a prefix such as "x_" e.g. x_style_name.css.

### Aborted commits
If the script stumbles upon errors because of a misconfiguration of the media_bundles the commit will be aborted. This is done by design. We don't want to checkin broken code. And only changes to the media bundles will be a possibility for those errors.

### Git hook setup
The pre-commit git hook is setup on the first http request. Hence if you clone the system the git-hook will not be in place before you have run the project. If you want you can always manually symlink the pre-commit hook from ".git/hooks/" to "git_hooks/" in the project root. The automatic sym-linking is made in "akvo/scripts/asset_manager/__init__.py"

### New source files
If you want to add a new source file to a bundle the actual media_bundle definition needs to commit before it's used for combining. Hence you need an extra commit of adding the source file to media_bundles and then before the second commit the pre-commit hook is triggered and that will generate a new combined file.

## Resources:
http://developer.yahoo.com/performance/rules.html
http://developer.yahoo.com/yui/compressor/
http://cjohansen.no/en/apache/using_a_far_future_expires_header

## Roadmap:
Would be nice to have validation of css & javascript(maybe even JSLint) as a requirement.